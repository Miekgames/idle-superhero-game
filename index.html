<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Idle Superhero Tycoon game. Collect, upgrade, and assign heroes of different classes to missions!" />
  <title>Idle Superhero Tycoon</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --tech-color: #4fc3f7;
      --magic-color: #ba68c8;
      --strength-color: #ff7043;
      --speed-color: #aed581;
  --guardian-color: #ffd700;
  --elemental-color: #00bcd4;
  --psychic-color: #e040fb;
  --cosmic-color: #f44336;
      --accent: #ffeb3b;
      --bg-main: #10131a;
      --bg-section: #181c25;
      --bg-card: #23272f;
      --text-main: #fff;
      --shadow: 0 2px 8px 0 rgba(0,0,0,0.13);
      --monster-color: #ffb74d;
      --craft-color: #00e676;
      --craft-card: #1a222c;
      --resource-bar: #ffd600;
      --sword-color: #90caf9;
      --shield-color: #ffe082;
      --dagger-color: #ff8a65;
      --power-color: #ce93d8;
    }
    body {
      background: linear-gradient(135deg,#111,#23272f 85%);
      color: var(--text-main);
      font-family: 'Montserrat', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    main { max-width: 980px; margin: 0 auto; padding: 15px; }
    header { text-align: center; padding: 28px 0 14px 0; letter-spacing: 1px;}
    h1 { font-size: 2.3em; margin-bottom: 0.3em; color: var(--accent); text-shadow: 0 2px 8px #0006;}
    h2 { font-weight: 700; letter-spacing: 1px; }
    section {
      background: var(--bg-section);
      margin: 18px 0;
      border-radius: 16px;
      padding: 22px;
      box-shadow: var(--shadow);
      transition: background 0.2s;
    }
    button, select {
      font-family: inherit;
      font-size: 1em;
      border-radius: 6px;
      border: none;
      outline: none;
      padding: 10px 22px;
      background: var(--accent);
      color: #111;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 4px 0 rgba(0,0,0,0.08);
    }
    button:hover:not(:disabled) {
      background: #ffd600;
      color: #0c1521;
      box-shadow: 0 4px 12px 0 rgba(0,0,0,0.16);
    }
    .hero, .mission, .shop-item, .gacha-result, .map-button, .upgrade-item, .monster-card {
      background: var(--bg-card);
      padding: 13px 10px;
      border-radius: 12px;
      text-align: center;
      box-shadow: var(--shadow);
      transition: transform 0.15s, box-shadow 0.15s;
      margin-bottom: 8px;
    }
    .monster-card {
      border: 2px solid var(--monster-color);
      margin-bottom: 16px;
    }
    .locked { opacity: 0.4; cursor: not-allowed; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 18px;
    }
    @media (max-width: 600px) {
      main { padding: 5px; }
      section { padding: 10px; }
      .grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
    }
    .shop-item, .resource-item {
      border: 2px solid var(--accent);
    }
    .resource-item {
      background: #232f1a;
      border: 2px solid var(--craft-color);
      margin-bottom: 6px;
    }
    /* Crafting section styling */
    #crafting {
      background: linear-gradient(120deg,#1a222c 80%,#222a36 100%);
      border: 2px solid var(--craft-color);
      box-shadow: 0 3px 18px 0 #00e67622;
      margin-bottom: 24px;
    }
    .craft-title {
      color: var(--craft-color);
      font-size: 1.25em;
      margin-bottom: 10px;
      letter-spacing: 1px;
      text-shadow: 0 2px 8px #00e67618;
    }
    .craft-card {
      background: var(--craft-card);
      border-radius: 10px;
      padding: 14px 9px 8px 9px;
      margin: 9px 0;
      box-shadow: 0 2px 8px #00e67611;
      border: 2px solid var(--craft-color);
      text-align: center;
      position: relative;
      transition: box-shadow 0.16s;
      min-height: 110px;
    }
    .craft-card.sword   { border-color: var(--sword-color);}
    .craft-card.shield  { border-color: var(--shield-color);}
    .craft-card.dagger  { border-color: var(--dagger-color);}
    .craft-card.power   { border-color: var(--power-color);}
    .craft-card h3 {
      margin: 0 0 8px 0;
      font-size: 1.15em;
      font-weight: bold;
      letter-spacing: 1px;
    }
    .craft-effect {
      font-size: 0.95em;
      color: #8ee6b0;
      margin-bottom: 5px;
      display: block;
    }
    .crafted-count {
      position: absolute;
      top: 7px; right: 15px;
      background: #222;
      color: var(--craft-color);
      font-weight: bold;
      font-size: 0.95em;
      padding: 2px 8px;
      border-radius: 9px;
    }
    .resource-bar-wrap {
      background: #181818;
      border-radius: 7px;
      padding: 8px 12px 8px 12px;
      margin-bottom: 13px;
      box-shadow: 0 2px 8px #ffd60008;
      font-size: 1.07em;
      letter-spacing: 1px;
    }
    .resource-bar {
      display: inline-block;
      min-width: 70px;
      margin-right: 16px;
      margin-bottom: 7px;
    }
    .resource-bar span {
      display: inline-block;
      background: var(--resource-bar);
      color: #23272f;
      font-weight: bold;
      border-radius: 6px;
      padding: 2px 10px;
      font-size: 1em;
      margin-left: 7px;
      min-width: 32px;
      text-align: right;
    }
    .shop-section-title {
      color: var(--accent);
      margin-bottom: 7px;
      text-shadow: 0 2px 8px #ffd60011;
    }
    /* Misc improvements */
    #log-content {
      max-height: 200px;
      overflow-y: auto;
      background: #181818;
      padding: 10px;
      border-radius: 6px;
      font-size: 0.96em;
      box-shadow: var(--shadow);
      margin-top: 10px;
      margin-bottom: 10px;
    }
    #total-mps {
      font-weight: bold;
      color: var(--accent);
      font-size: 1.2em;
    }
    .money-flash {
      animation: flashMoney 0.5s;
    }
    @keyframes flashMoney {
      0% { background: #ffd600; color: #222; }
      100% { background: none; color: inherit; }
    }
  </style>
</head>
<body>
  <div id="loading-screen" style="position:fixed; top:0; left:0; width:100vw; height:100vh; background:#1a1a2e; color:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999;">
  <h1 style="margin-bottom:0.4em;">Idle Superhero Game</h1>
  <p style="margin-bottom:1em; font-size:1.1em;">Assemble your heroes, save the city, and grow stronger while youâ€™re away!</p>
  <div id="loading-tip" style="margin-bottom:1em; font-style:italic;">Tip: Upgrade your heroes regularly for maximum power!</div>
  <div style="width:300px; height:20px; background:#222; border-radius:10px; overflow:hidden; margin-bottom:0.5em;">
    <div id="loading-bar" style="height:100%; width:0; background:#00c3ff; transition:width 0.2s;"></div>
  </div>
  <div id="loading-percent">0%</div>
</div>
  <main>
    <header>
      <h1>Idle Superhero Tycoon</h1>
    </header>
    <section aria-labelledby="player-stats-title" id="player-stats">
      <h2 id="player-stats-title">Player Stats</h2>
      <p>Level: <span id="level">1</span></p>
      <p>XP: <span id="xp">0</span> / <span id="xpToLevel">100</span></p>
      <p>Money: $<span id="money">100</span></p>
      <p>Current Map: <span id="currentMap">Map 1</span></p>
      <button class="save-load-btn" id="save-btn" aria-label="Save Game">Save Game</button>
      <button class="save-load-btn" id="load-btn" aria-label="Load Game">Load Game</button>
      <button class="save-load-btn" id="reset-btn" aria-label="Reset Game">Reset</button>
    </section>
    <!-- Developer/Auto Controls -->
<div id="dev-controls" style="margin:18px 0 0 0; display:flex; gap:8px; align-items:center;">
  <input type="text" id="playerNameInput" placeholder="Set Name..." style="padding:6px; border-radius:4px; border:none;">
  <button id="setNameBtn" style="padding:6px 14px;">Set Name</button>
  <button id="maxButton" style="display:none; padding:6px 14px; background:#d32f2f; color:white; border:none; border-radius:4px; font-weight:bold;">MAX</button>
  <button id="autoGrindButton" style="padding:6px 14px; background:#1976d2; color:white; border:none; border-radius:4px; font-weight:bold;">Auto-Grind: OFF</button>
</div>
<p style="margin:7px 0 0 0">Name: <span id="currentPlayerName" style="font-weight:bold;color:var(--accent);">Anonymous</span></p>
    <section id="log-section">
      <button id="toggle-log-btn" aria-expanded="true">Hide Log</button>
      <h2 style="display:inline-block">Game Log</h2>
      <div id="log-content"></div>
    </section>
   <section aria-labelledby="class-legend-title" id="class-legend">
  <h2 id="class-legend-title">Hero Classes</h2>
  <ul style="display:flex; gap:24px; list-style:none; padding:0; margin:0;">
    <li><span class="class tech" title="Technology heroes excel at gadgets and hacking.">Tech</span></li>
    <li><span class="class magic" title="Magic heroes use spells and arcane arts.">Magic</span></li>
    <li><span class="class strength" title="Strength heroes focus on raw power.">Strength</span></li>
    <li><span class="class speed" title="Speed heroes are quick and agile.">Speed</span></li>
    <!-- Add new hero classes below -->
    <li><span class="class guardian" title="Guardians shield your team.">Guardian</span></li>
    <li><span class="class elemental" title="Elementals bring unpredictable power.">Elemental</span></li>
    <li><span class="class psychic" title="Psychics manipulate outcomes.">Psychic</span></li>
    <li><span class="class cosmic" title="Cosmic heroes give global boosts.">Cosmic</span></li>
  </ul>
</section>
    <section aria-labelledby="map-switch-title" id="map-switch">
      <h2 id="map-switch-title">Maps <span aria-label="Unlock maps by leveling up heroes">(Unlock every few hero levels)</span></h2>
      <div class="grid" id="map-buttons"></div>
    </section>
    <section aria-labelledby="heroes-title" id="heroes">
      <h2 id="heroes-title">Owned Heroes</h2>
      <div class="grid" id="heroes-list"></div>
      <p style="margin-top:10px">Total Money Per Second: $<span id="total-mps">0</span></p>
    </section>
    <section aria-labelledby="shop-title" id="shop">
      <h2 id="shop-title">Hero Shop</h2>
      <label for="class-filter">Filter by Class:</label>
      <select id="class-filter" aria-label="Filter heroes by class">
        <option value="">All</option>
        <option value="Tech">Tech</option>
        <option value="Magic">Magic</option>
        <option value="Strength">Strength</option>
        <option value="Speed">Speed</option>
      </select>
      <div class="grid" id="shop-heroes"></div>
    </section>
    <!-- Resource Shop Section -->
    <section aria-labelledby="shop-resources-title" id="shop-resources">
      <h2 id="shop-resources-title" class="shop-section-title">Resource Shop</h2>
      <div class="grid" id="resource-shop-list"></div>
    </section>
    <!-- Crafting Section -->
    <section aria-labelledby="crafting-title" id="crafting">
      <h2 id="crafting-title" class="craft-title">Crafting</h2>
      <div id="crafting-resources"></div>
      <div id="crafting-recipes" class="grid"></div>
    </section>
    <!-- Research Lab Section -->
    <section aria-labelledby="lab-title" id="lab">
      <h2 id="lab-title">Research Lab</h2>
      <div class="grid" id="upgrade-list"></div>
    </section>
    <section aria-labelledby="missions-title" id="missions">
      <h2 id="missions-title">Missions</h2>
      <button id="start-all-missions-btn">Start All Missions</button>
      <div class="grid" id="missions-list"></div>
    </section>
    <!-- MONSTER FIGHTING SYSTEM -->
    <section aria-labelledby="monster-title" id="monster-arena">
      <h2 id="monster-title">Monster Arena</h2>
      <div id="monster-list"></div>
    </section>
  </main>
  <script>
    window.onload = function() {
    // Attempt to load saved game from localStorage
    const savedGame = localStorage.getItem('save');
    if (savedGame) {
        // Replace loadGame with whatever function you use to load your save
        loadGame(JSON.parse(savedGame));
    } else {
        // If you have a function to start a new game, you can call it here
        startNewGame();
    }
};
    // --- Constants and Data ---
    const MAP_COUNT = 15;
    const HERO_COUNT = 50;
    const LEVELS_PER_MAP = 20;
    const mapNames = [
      "Skyline City","Shadow District","Neon Harbor","Crystal Caverns","Ironworks","Solaris Heights","Quantum Quarter",
      "Twilight Outlands","Meteorite Falls","Circuit Spires","Aetherium Isles","Obsidian Expanse","Celestial Park",
      "Echoing Depths","Titan's Reach"
    ];
    const maps = Array.from({length: MAP_COUNT}, (_,i) => ({
      name: mapNames[i],
      unlockLevel: 1 + i * LEVELS_PER_MAP
    }));

    const heroNames = [
      "Blaze", "Frostbite", "Shockwave", "Inferno", "Glacier", "Sandstorm", "Wildwood", "Tsunami", "Voltar", "Blizzard",
      "Cinder", "Echo", "Ironclad", "Stormbreaker", "Phantom", "Nova", "Titan", "Solarflare", "Quake", "Tempest",
      "Shadowstrike", "Glitch", "Aurora", "Ember", "Fang", "Hydra", "Bolt", "Vortex", "Frostfang", "Dune",
      "Gale", "Nightshade", "Tide", "Pulse", "Flare", "Glint", "Blitz", "Shadow", "Cascade", "Steelclaw",
      "Quasar", "Nebula", "Pyro", "Arctic Fox", "Mirage", "Specter", "Solaris", "Cyclone", "Darkwave", "Luminara"
    ];
    while (heroNames.length < HERO_COUNT) heroNames.push("Hero" + (heroNames.length + 1));

 // Add new color variables in your <style> section:
/*
:root {
  --tech-color: #4fc3f7;
  --magic-color: #ba68c8;
  --strength-color: #ff7043;
  --speed-color: #aed581;
  --guardian-color: #ffd700;
  --elemental-color: #00bcd4;
  --psychic-color: #e040fb;
  --cosmic-color: #f44336;
}
*/

const heroClasses = [
  { name: "Tech", color: "var(--tech-color)", desc: "Automation and hacking. Bonus to mission rewards, can 'Hack' to instantly complete missions." },
  { name: "Magic", color: "var(--magic-color)", desc: "Spells and arcane arts. Chance to double XP or money, has 'Arcane Surge' skill." },
  { name: "Strength", color: "var(--strength-color)", desc: "Raw power. Higher flat MPS, 'Smash' for bonus cash." },
  { name: "Speed", color: "var(--speed-color)", desc: "Quick and agile. Shorter mission times, 'Dash' for instant money." },
  { name: "Guardian", color: "var(--guardian-color)", desc: "Defensive. Reduces penalties, 'Shield All' to boost hero defenses." },
  { name: "Elemental", color: "var(--elemental-color)", desc: "Unpredictable. Triggers random elemental bonuses, 'Elemental Surge' for special effects." },
  { name: "Psychic", color: "var(--psychic-color)", desc: "Mind powers. Can reroll mission rewards, 'Mind Twist' to manipulate outcomes." },
  { name: "Cosmic", color: "var(--cosmic-color)", desc: "Universal. Rare, global boosts, 'Cosmic Wave' for big bonuses." }
];

// Update your hero creation logic to support the new classes (assuming HERO_COUNT and heroNames already set)
const heroes = Array.from({ length: HERO_COUNT }, (_, i) => {
  const heroClass = heroClasses[i % heroClasses.length];
  return {
    id: i + 1,
    name: heroNames[i],
    mps: 1 + Math.floor(Math.random() * 10 + i), // Adjust as needed for balance
    price: 100 + i * 50,
    map: maps[Math.floor(i / (HERO_COUNT / MAP_COUNT))].name,
    unlockLevel: 1 + Math.floor(i / (HERO_COUNT / MAP_COUNT)) * LEVELS_PER_MAP,
    class: heroClass.name,
    color: heroClass.color,
    desc: heroClass.desc,
    // Example of adding class-specific skill cooldowns, etc.
    skillCooldown: 0
  };
});

// Example: add a method to trigger class skills (call from UI button)
function activateHeroSkill(heroId) {
  const hero = heroes.find(h => h.id === heroId);
  if (!hero || hero.skillCooldown > 0) return;
  switch (hero.class) {
    case "Tech":
      // Instantly complete a mission (pseudo)
      completeBestMission(heroId);
      break;
    case "Magic":
      // Double XP/money for limited time
      player.magicBoost = 2;
      setTimeout(() => player.magicBoost = 1, 60000); // 1 min
      break;
    case "Strength":
      // Smash: instant cash
      player.money += hero.mps * 50;
      break;
    case "Speed":
      // Dash: instant MPS gain
      player.money += hero.mps * 30;
      break;
    case "Guardian":
      // Shield all: reduce mission penalties
      player.guardianShield = true;
      setTimeout(() => player.guardianShield = false, 60000);
      break;
    case "Elemental":
      // Elemental surge: random bonus
      elementalSurge(heroId);
      break;
    case "Psychic":
      // Reroll mission reward
      rerollMissionReward(heroId);
      break;
    case "Cosmic":
      // Boost all hero MPS for a short period
      player.cosmicBoost = 2;
      setTimeout(() => player.cosmicBoost = 1, 60000);
      break;
  }
  hero.skillCooldown = 300; // e.g., 5 min cooldown
}

// Example: elementalSurge function, customize as needed
function elementalSurge(heroId) {
  const effects = [
    () => player.money += 500, // Fire: money
    () => player.xp += 100,    // Ice: xp
    () => player.magicBoost = 2, // Wind: boost
    () => player.strengthBoost = 2 // Earth: boost
  ];
  const effect = effects[Math.floor(Math.random() * effects.length)];
  effect();
  setTimeout(() => {
    player.magicBoost = 1;
    player.strengthBoost = 1;
  }, 60000);
}

// Call activateHeroSkill from a button in your hero UI, e.g.:
// <button onclick="activateHeroSkill(hero.id)">Use Skill</button>

// In your MPS calculation and boosts, add support for new classes and cosmic boost
function getHeroClassBoost(hero) {
  let boost = 1;
  if (hero.class === "Tech") boost *= player.techBoost || 1;
  if (hero.class === "Magic") boost *= player.magicBoost || 1;
  if (hero.class === "Strength") boost *= player.strengthBoost || 1;
  if (hero.class === "Speed") boost *= player.speedBoost || 1;
  if (hero.class === "Guardian") boost *= player.guardianBoost || 1;
  if (hero.class === "Elemental") boost *= player.elementalBoost || 1;
  if (hero.class === "Psychic") boost *= player.psychicBoost || 1;
  if (hero.class === "Cosmic") boost *= player.cosmicBoost || 1;
  return boost;
}

// In your UI rendering, use hero.color for class color, and show hero.desc as a tooltip or info panel.
    const heroes = Array.from({length: HERO_COUNT}, (_,i) => ({
      id: i+1,
      name: heroNames[i],
      mps: 1 + Math.floor(Math.random()*10) + i,
      price: 100 + i*50,
      map: maps[Math.floor(i/(HERO_COUNT/MAP_COUNT))].name,
      unlockLevel: 1 + Math.floor(i/(HERO_COUNT/MAP_COUNT)) * LEVELS_PER_MAP,
      class: heroClasses[i % heroClasses.length]
    }));

    // --- Monster Fighting System ---
    const monsterNames = [
      "Street Goon", "Mega Bot", "Arcane Shade", "Steel Serpent", "Crimson Ogre", "Cyber Wraith",
      "Titan Drone", "Night Howler", "Crystal Hydra", "Lava Fiend", "Quantum Slime", "Spectral Wolf",
      "Obsidian Golem", "Meteor Spider", "Celestial Squid"
    ];
    function getMonsterListForPlayerLevel(lv) {
      let unlocked = Math.min(Math.floor(lv / 5) + 1, monsterNames.length);
      let monsters = [];
      for (let i = 0; i < unlocked; ++i) {
        monsters.push({
          id: i+1,
          name: monsterNames[i],
          maxHealth: 20 + i*15 + lv*3,
          xp: 10 + i*5 + lv*2,
          money: 15 + i*8 + lv*3,
          level: i*3 + 1
        });
      }
      return monsters;
    }

    // Missions
    const missionNamesPerMap = [
      ["Stop the Bank Heist", "Rescue the Mayor", "Defuse the Skyscraper Bomb", "Intercept Midnight Robbery", "Save the Runaway Train", "Save the Cat from a Tree", "Repair the Broken Bridge"],
      ["Infiltrate the Syndicate", "Shadow Alley Chase", "Break the Smuggling Ring", "Decode Secret Messages", "Silent Sabotage"],
      ["Guard the Neon Docks", "Battle the Pirate Crew", "Protect Cargo Ships", "Halt Black Market Deal", "Rescue Hostages at Pier 9"],
      ["Retrieve Crystal Shards", "Defeat the Cave Beast", "Rescue Trapped Miners", "Map the Hidden Passages", "Secure the Cavern Entrance"],
      ["Stop Factory Sabotage", "Rescue Workers", "Shut Down Rogue Machines", "Protect Prototype Tech", "Investigate Explosions"],
      ["Prevent Solar Flare", "Protect the Observatory", "Evacuate Residents", "Apprehend Arsonist", "Restore Power Grid"],
      ["Contain Anomaly", "Rescue Lab Scientists", "Stop Tech Theft", "Seal Quantum Rift", "Hack the Mainframe"],
      ["Patrol the Borderlands", "Rescue Lost Explorers", "Defeat Outland Marauders", "Secure Outpost", "Recover Lost Supplies"],
      ["Investigate Meteor Crash", "Evacuate Impact Zone", "Battle Alien Invaders", "Research Meteor Fragments", "Quarantine Contaminated Area"],
      ["Protect Data Towers", "Chase Cyber Criminals", "Repair Main Circuits", "Install Security Upgrades", "Foil Hacking Attempt"],
      ["Rescue Drifting Ships", "Battle Sky Pirates", "Seal Dimensional Rifts", "Protect Floating Gardens", "Restore Weather Control"],
      ["Track Rogue Mutants", "Secure Resource Convoy", "Defend Outlying Camps", "Investigate Disappearances", "Survey Dangerous Terrain"],
      ["Calm the Rampaging Beast", "Rescue Tourists", "Protect Ancient Relics", "Stop the Park Poachers", "Find Lost Children"],
      ["Explore the Abyss Ruins", "Rescue Divers", "Fight the Abyssal Leviathan", "Secure the Research Sub", "Map the Underwater Tunnels"],
      ["Climb the Titan Spire", "Defeat the Giant Golem", "Rescue the Expedition", "Protect the Mountain Base", "Secure the Ancient Relic"]
    ];
    let missions = [];
    let missionId = 1;
    for (let mapIdx = 0; mapIdx < missionNamesPerMap.length; mapIdx++) {
      for (let i = 0; i < missionNamesPerMap[mapIdx].length; i++) {
        missions.push({
          id: missionId,
          name: missionNamesPerMap[mapIdx][i],
          xpReward: 20 + mapIdx * 5 + i,
          moneyReward: 25 + mapIdx * 10 + i * 3,
          minLevel: 1 + mapIdx * LEVELS_PER_MAP,
          baseDuration: 5 + mapIdx + i
        });
        missionId++;
      }
    }

    // --- Player state ---
    let player = {
      level: 1,
      xp: 0,
      money: 100,
      heroesOwned: [1],
      currentMap: maps[0].name,
      heroMissions: {},
      incomeBoost: 1,
      missionBoost: 1,
      techBoost: 1,
      magicBoost: 1,
      strengthBoost: 1,
      speedBoost: 1,
      resources: { iron: 0, wood: 0, crystal: 0 },
      craftedItems: { sword: 0, shield: 0, dagger: 0, power: 0 }
    };

    // --- Monster State ---
    let monsterStates = [];

    // --- UI elements ---
    const levelEl = document.getElementById('level');
    const xpEl = document.getElementById('xp');
    const xpToLevelEl = document.getElementById('xpToLevel');
    const moneyEl = document.getElementById('money');
    const currentMapEl = document.getElementById('currentMap');
    const heroesListEl = document.getElementById('heroes-list');
    const shopHeroesEl = document.getElementById('shop-heroes');
    const missionsListEl = document.getElementById('missions-list');
    const mapButtonsEl = document.getElementById('map-buttons');
    const saveBtn = document.getElementById('save-btn');
    const loadBtn = document.getElementById('load-btn');
    const resetBtn = document.getElementById('reset-btn');
    const totalMpsEl = document.getElementById('total-mps');
    const classFilterEl = document.getElementById('class-filter');
    const upgradeListEl = document.getElementById('upgrade-list');
    const logContentEl = document.getElementById('log-content');
    const logSectionEl = document.getElementById('log-section');
    const toggleLogBtn = document.getElementById('toggle-log-btn');
    const startAllMissionsBtn = document.getElementById('start-all-missions-btn');
    const monsterListEl = document.getElementById('monster-list');
    const resourceShopListEl = document.getElementById('resource-shop-list');
    const craftingResourcesEl = document.getElementById('crafting-resources');
    const craftingRecipesEl = document.getElementById('crafting-recipes');

    // --- Crafting Recipes ---
    const recipes = [
      {
        name: "Sword",
        key: "sword",
        cost: { iron: 3, wood: 1 },
        effect: "Increases arena damage by +7 per sword.",
        color: "sword"
      },
      {
        name: "Shield",
        key: "shield",
        cost: { iron: 2, wood: 2 },
        effect: "Reduces monster damage by 10% per shield.",
        color: "shield"
      },
      {
        name: "Dagger",
        key: "dagger",
        cost: { iron: 2, wood: 1 },
        effect: "Small chance for critical hit (+30% dmg per dagger).",
        color: "dagger"
      },
      {
        name: "Power",
        key: "power",
        cost: { crystal: 5 },
        effect: "Unlocks special attack (adds +15 arena damage).",
        color: "power"
      }
    ];

    // --- Resource Shop Data ---
    const resourceShopItems = [
      { name: "Iron", key: "iron", price: 20, color: "#90caf9" },
      { name: "Wood", key: "wood", price: 10, color: "#ffd54f" },
      { name: "Crystal", key: "crystal", price: 40, color: "#ce93d8" }
    ];

    // --- Research Lab Upgrades (unchanged) ---
    const upgrades = [
      {
        id: 1,
        name: "Boost Hero Income +10%",
        desc: "All heroes earn 10% more money.",
        cost: 500,
        purchased: false,
        apply(player) { player.incomeBoost *= 1.10; }
      },
      {
        id: 2,
        name: "Boost Hero Income +25%",
        desc: "All heroes earn 25% more money.",
        cost: 2500,
        purchased: false,
        apply(player) { player.incomeBoost *= 1.25; }
      },
      {
        id: 3,
        name: "Boost Hero Income +50%",
        desc: "All heroes earn 50% more money.",
        cost: 10000,
        purchased: false,
        apply(player) { player.incomeBoost *= 1.50; }
      },
      {
        id: 4,
        name: "Mission Rewards +20%",
        desc: "Earn 20% more money from missions.",
        cost: 20000,
        purchased: false,
        apply(player) { player.missionBoost *= 1.20; }
      },
      {
        id: 5,
        name: "Tech Class Power",
        desc: "Tech class heroes earn double.",
        cost: 25000,
        purchased: false,
        apply(player) { player.techBoost = 2; }
      },
      {
        id: 6,
        name: "Magic Class Power",
        desc: "Magic class heroes earn double.",
        cost: 25000,
        purchased: false,
        apply(player) { player.magicBoost = 2; }
      },
      {
        id: 7,
        name: "Strength Class Power",
        desc: "Strength class heroes earn double.",
        cost: 25000,
        purchased: false,
        apply(player) { player.strengthBoost = 2; }
      },
      {
        id: 8,
        name: "Speed Class Power",
        desc: "Speed class heroes earn double.",
        cost: 25000,
        purchased: false,
        apply(player) { player.speedBoost = 2; }
      }
    ];

    // --- UI Update Functions ---
    function updatePlayerUI() {
      levelEl.textContent = player.level;
      xpEl.textContent = player.xp;
      xpToLevelEl.textContent = xpToNextLevel(player.level);
      moneyEl.textContent = player.money.toFixed(2);
    }
    function flashMoney() {
      moneyEl.classList.add('money-flash');
      setTimeout(() => moneyEl.classList.remove('money-flash'), 400);
    }
    function updateHeroesUI() {
      heroesListEl.innerHTML = '';
      let totalMps = 0;
      player.heroesOwned.forEach((id) => {
        const hero = heroes.find(h => h.id === id);
        if (!hero) return;
        // Apply per-class boosts:
        let classBoost = 1;
        if (hero.class === "Tech") classBoost = player.techBoost || 1;
        if (hero.class === "Magic") classBoost = player.magicBoost || 1;
        if (hero.class === "Strength") classBoost = player.strengthBoost || 1;
        if (hero.class === "Speed") classBoost = player.speedBoost || 1;
        totalMps += hero.mps * classBoost;
        const div = document.createElement('div');
        div.className = 'hero';
        div.innerHTML = `<strong>${hero.name}</strong><br>
          <span class="class ${hero.class.toLowerCase()}">${hero.class}</span><br>
          Map: ${hero.map}<br>
          MPS: $${(hero.mps * classBoost).toFixed(2)}`;
        heroesListEl.appendChild(div);
      });
      // Apply upgrade boost
      const boost = player.incomeBoost || 1;
      totalMpsEl.textContent = (totalMps * boost).toFixed(2);
    }
    classFilterEl.onchange = updateShopUI;
    function updateShopUI() {
      shopHeroesEl.innerHTML = '';
      const filter = classFilterEl.value;
      const available = heroes.filter(h =>
        h.map === player.currentMap &&
        !player.heroesOwned.includes(h.id) &&
        player.level >= h.unlockLevel &&
        (filter === "" || h.class === filter)
      );
      if (!available.length) {
        shopHeroesEl.textContent = 'No heroes available to buy here.';
        return;
      }
      available.forEach(hero => {
        const div = document.createElement('div');
        div.className = 'shop-item';
        div.innerHTML = `<strong>${hero.name}</strong><br>
          <span class="class ${hero.class.toLowerCase()}">${hero.class}</span><br>
          Price: $${hero.price}<br>
          MPS: $${hero.mps}<br>
          <button ${player.money < hero.price ? 'disabled' : ''}>Buy</button>`;
        div.querySelector('button').onclick = function() {
          if (player.money >= hero.price) {
            player.money -= hero.price;
            player.heroesOwned.push(hero.id);
            addLog(`You bought ${hero.name} for $${hero.price}!`);
            flashMoney();
            updateAll();
          } else {
            addLog("Not enough money to buy this hero.");
          }
        };
        shopHeroesEl.appendChild(div);
      });
    }
    function updateShopResourcesUI() {
      resourceShopListEl.innerHTML = '';
      resourceShopItems.forEach(item => {
        const div = document.createElement('div');
        div.className = 'resource-item';
        div.style.borderColor = item.color;
        div.innerHTML = `
          <strong style="color:${item.color}">${item.name}</strong><br>
          <span>Price: $${item.price}</span><br>
          <button ${player.money < item.price ? 'disabled' : ''}>Buy</button>
        `;
        div.querySelector('button').onclick = function() {
          if (player.money >= item.price) {
            player.money -= item.price;
            player.resources[item.key] = (player.resources[item.key] || 0) + 1;
            addLog(`You bought 1 ${item.name}!`);
            flashMoney();
            updateCraftingUI();
            updatePlayerUI();
            updateShopResourcesUI();
          } else {
            addLog("Not enough money to buy this resource.");
          }
        }
        resourceShopListEl.appendChild(div);
      });
    }

    function updateCraftingResourcesUI() {
      // Show nice resource bars
      const lines = resourceShopItems.map(item =>
        `<div class="resource-bar" style="color:${item.color}">
          <img src="https://img.icons8.com/ios-filled/20/${item.color.replace('#','')}/${item.name.toLowerCase()}.png" style="vertical-align:middle;display:none">
          ${item.name}: <span>${player.resources[item.key] || 0}</span>
        </div>`
      ).join('');
      craftingResourcesEl.innerHTML = `<div class="resource-bar-wrap">${lines}</div>`;
    }
    function updateCraftingRecipesUI() {
      craftingRecipesEl.innerHTML = "";
      recipes.forEach(recipe => {
        const canCraft = Object.entries(recipe.cost).every(([k, need]) => (player.resources[k] || 0) >= need);
        // Show what you own
        const count = player.craftedItems[recipe.key] || 0;
        let costList = Object.entries(recipe.cost).map(([k, v]) => {
          const color = (resourceShopItems.find(r=>r.key===k)||{}).color || "#eee";
          return `<span style="color:${color}">${v} ${k.charAt(0).toUpperCase()+k.slice(1)}</span>`;
        }).join(' &nbsp; ');
        const div = document.createElement('div');
        div.className = `craft-card ${recipe.color}`;
        div.innerHTML = `
          <h3>${recipe.name}</h3>
          <span class="craft-effect">${recipe.effect}</span>
          <div style="margin-bottom:7px;">${costList}</div>
          <button ${canCraft ? '' : 'disabled'}>Craft</button>
          <div class="crafted-count">x${count}</div>
        `;
        div.querySelector('button').onclick = function() {
          Object.entries(recipe.cost).forEach(([k, need]) => player.resources[k] -= need);
          player.craftedItems[recipe.key] = (player.craftedItems[recipe.key] || 0) + 1;
          addLog(`Crafted 1 ${recipe.name}!`);
          updateCraftingUI();
        };
        craftingRecipesEl.appendChild(div);
      });
    }
    function updateCraftingUI() {
      updateCraftingResourcesUI();
      updateCraftingRecipesUI();
    }

    function updateMapButtonsUI() {
      mapButtonsEl.innerHTML = '';
      maps.forEach(map => {
        const unlocked = player.level >= map.unlockLevel;
        const btn = document.createElement('button');
        btn.textContent = map.name + (unlocked ? '' : ' (Locked)');
        btn.className = 'map-button' + (unlocked ? '' : ' locked');
        btn.disabled = !unlocked;
        btn.onclick = () => {
          if (player.currentMap === map.name) return;
          player.currentMap = map.name
          updatePlayerUI();
          updateShopUI();
        };
        mapButtonsEl.appendChild(btn);
      });
    }

    // --- MISSIONS UI ---
    function updateMissionsUI() {
      missionsListEl.innerHTML = '';
      player.heroesOwned.forEach(heroId => {
        const hero = heroes.find(h => h.id === heroId);
        const assign = player.heroMissions[heroId] || {};
        const div = document.createElement('div');
        div.className = 'mission';
        // Mission assignment dropdown
        let missionOptions = `<option value="">Assign Mission</option>`;
        missions.forEach(miss => {
          if (player.level >= miss.minLevel) {
            missionOptions += `<option value="${miss.id}" ${assign.missionId==miss.id?'selected':''}>${miss.name}</option>`;
          }
        });
        if (assign.inProgress) {
          div.innerHTML = `<strong>${hero.name}</strong><br>
            <span class="class ${hero.class.toLowerCase()}">${hero.class}</span><br>
            On: ${missions.find(m=>m.id===assign.missionId)?.name || 'Unknown'}<br>
            Time left: <span id="hero-mission-timer-${heroId}">${assign.timeLeft}</span>s<br>
            <button disabled>In Progress</button>`;
        } else {
          div.innerHTML = `<strong>${hero.name}</strong><br>
            <span class="class ${hero.class.toLowerCase()}">${hero.class}</span><br>
            <select class="hero-mission-select" aria-label="Assign mission to ${hero.name}">${missionOptions}</select>
            <button>Start Mission</button>`;
          const select = div.querySelector('.hero-mission-select');
          select.onchange = (e) => {
            assign.missionId = parseInt(e.target.value)||null;
            player.heroMissions[heroId] = assign;
          };
          div.querySelector('button').onclick = () => {
            if (!assign.missionId) {
              alert('Assign a mission first!');
              return;
            }
            assign.inProgress = true;
            const base = missions.find(m=>m.id===assign.missionId);
            assign.timeLeft = base.baseDuration;
            player.heroMissions[heroId] = assign;
            addLog(`${hero.name} started ${base.name}.`);
            updateMissionsUI();
            startHeroMissionTimer(heroId);
          };
        }
        missionsListEl.appendChild(div);
      });
    }

    // --- "Start All Missions" with auto-assign logic ---
    startAllMissionsBtn.onclick = function() {
      player.heroesOwned.forEach(heroId => {
        let assign = player.heroMissions[heroId] || {};
        if (!assign.inProgress) {
          if (!assign.missionId) {
            // Auto-assign the first available mission for this hero
            const available = missions.filter(miss => player.level >= miss.minLevel);
            if (available.length) {
              assign.missionId = available[0].id;
            }
          }
          if (assign.missionId) {
            assign.inProgress = true;
            const base = missions.find(m => m.id === assign.missionId);
            assign.timeLeft = base.baseDuration;
            player.heroMissions[heroId] = assign;
            addLog(`${heroes.find(h => h.id === heroId).name} started ${base.name}.`);
            startHeroMissionTimer(heroId);
          }
        }
      });
      updateMissionsUI();
    };

    function updateLabUI() {
      upgradeListEl.innerHTML = '';
      upgrades.forEach((upg, idx) => {
        const div = document.createElement('div');
        div.className = 'upgrade-item';
        div.innerHTML = `<strong>${upg.name}</strong><br>
          <span style="font-size:0.95em">${upg.desc}</span><br>
          Cost: $${upg.cost}<br>
          <button ${upg.purchased || player.money < upg.cost ? 'disabled' : ''}>
            ${upg.purchased ? 'Purchased' : 'Buy'}
          </button>`;
        div.querySelector('button').onclick = function() {
          if (player.money >= upg.cost && !upg.purchased) {
            player.money -= upg.cost;
            upg.purchased = true;
            upg.apply(player);
            addLog(`You bought upgrade: ${upg.name}`);
            flashMoney();
            updateAll();
          }
        };
        upgradeListEl.appendChild(div);
      });
    }

    function xpToNextLevel(level) {
      return 100 + (level - 1) * 50;
    }

    function updateAll() {
      updatePlayerUI();
      updateHeroesUI();
      updateShopUI();
      updateShopResourcesUI();
      updateCraftingUI();
      updateMapButtonsUI();
      updateMissionsUI();
      updateLabUI();
      updateMonstersUI();
    }

    // Hero income (idle) with max money cap
    setInterval(() => {
      let totalMps = 0;
      player.heroesOwned.forEach(id => {
        const hero = heroes.find(h => h.id === id);
        if (!hero) return;
        let classBoost = 1;
        if (hero.class === "Tech") classBoost = player.techBoost || 1;
        if (hero.class === "Magic") classBoost = player.magicBoost || 1;
        if (hero.class === "Strength") classBoost = player.strengthBoost || 1;
        if (hero.class === "Speed") classBoost = player.speedBoost || 1;
        totalMps += hero.mps * classBoost;
      });
      // Apply upgrade boost
      const boost = player.incomeBoost || 1;
      let earned = totalMps * boost / 2;
      // Clamp to not exceed max money
      const MONEY_CAP = 999999999999999999999999999999999999999999999999999999999999999;
      if (player.money + earned > MONEY_CAP) {
        earned = Math.max(0, MONEY_CAP - player.money);
      }
      player.money += earned;
      if (player.money > MONEY_CAP) player.money = MONEY_CAP;
      moneyEl.textContent = player.money.toFixed(2);
      totalMpsEl.textContent = (totalMps * boost).toFixed(2);
    }, 500);

    function startHeroMissionTimer(heroId) {
      const assign = player.heroMissions[heroId];
      if (!assign || !assign.inProgress) return;
      function tick() {
        if (!assign.inProgress) return;
        assign.timeLeft -= 1;
        const timerSpan = document.getElementById(`hero-mission-timer-${heroId}`);
        if (timerSpan) timerSpan.textContent = assign.timeLeft;
        if (assign.timeLeft <= 0) {
          assign.inProgress = false;
          const base = missions.find(m=>m.id===assign.missionId);
          let missionMoney = base.moneyReward * (player.missionBoost || 1);
          player.money += missionMoney;
          player.xp += base.xpReward;
          addLog(`${heroes.find(h=>h.id===heroId).name} completed ${base.name}! +$${missionMoney}, +${base.xpReward}xp`);
          flashMoney();
          checkLevelUp();
          updateAll();
        } else {
          setTimeout(tick, 1000);
        }
      }
      tick();
    }

    function checkLevelUp() {
      let nextLevelXp = xpToNextLevel(player.level);
      while (player.xp >= nextLevelXp) {
        player.xp -= nextLevelXp;
        player.level++;
        addLog(`Level Up! Now level ${player.level}.`);
        updateMapButtonsUI();
        updateShopUI();
        updateMissionsUI();
        updateMonstersUI();
        nextLevelXp = xpToNextLevel(player.level);
      }
      updatePlayerUI();
    }

    // --- Game Log Feature ---
    function addLog(msg) {
      if (!logContentEl) return;
      const p = document.createElement('div');
      p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logContentEl.appendChild(p);
      logContentEl.scrollTop = logContentEl.scrollHeight;
    }

    // === Save/load/reset to include upgrades, crafting, resources, monster state ===
    saveBtn.onclick = function() {
      player.upgradesPurchased = upgrades.map(u => u.purchased);
      player.monsterStates = monsterStates; // Save monster healths
      localStorage.setItem('idle-superhero-save', JSON.stringify(player));
      addLog('Game saved!');
    };
    loadBtn.onclick = function() {
      const data = localStorage.getItem('idle-superhero-save');
      if (data) {
        Object.assign(player, JSON.parse(data));
        // Restore upgrades
        if (player.upgradesPurchased) {
          player.upgradesPurchased.forEach((p, i) => {
            upgrades[i].purchased = p;
            if (p) upgrades[i].apply(player);
          });
        }
        // Restore monster states
        monsterStates = player.monsterStates || [];
        // Ensure crafting/resources keys exist
        player.resources = player.resources || { iron: 0, wood: 0, crystal: 0 };
        player.craftedItems = player.craftedItems || { sword: 0, shield: 0, dagger: 0, power: 0 };
        addLog('Game loaded!');
        updateAll();
      }
    };
    resetBtn.onclick = function() {
      if (confirm('Reset your progress?')) {
        localStorage.removeItem('idle-superhero-save');
        addLog('Game reset!');
        location.reload();
      }
    };

    // Hideable log functionality
    toggleLogBtn.onclick = function() {
      if (logContentEl.style.display !== "none") {
        logContentEl.style.display = "none";
        toggleLogBtn.textContent = "Show Log";
        toggleLogBtn.setAttribute('aria-expanded', 'false');
      } else {
        logContentEl.style.display = "";
        toggleLogBtn.textContent = "Hide Log";
        toggleLogBtn.setAttribute('aria-expanded', 'true');
      }
    };

    // --- MONSTER FIGHTING SYSTEM with crafting bonuses ---
    function updateMonstersUI() {
      const monsters = getMonsterListForPlayerLevel(player.level);
      // If monsterStates array is empty or doesn't match, reset
      if (monsterStates.length !== monsters.length) {
        monsterStates = monsters.map(m => ({
          ...m,
          currentHealth: m.maxHealth
        }));
      }
      monsterListEl.innerHTML = '';
      monsterStates.forEach((monster, idx) => {
        // Card
        const div = document.createElement('div');
        div.className = 'monster-card';
        const healthPercent = Math.max(0, monster.currentHealth/monster.maxHealth*100);
        div.innerHTML = `
          <strong>${monster.name}</strong> (Lv.${monster.level})<br>
          <div class="monster-healthbar-bg">
            <div class="monster-healthbar" style="width:${healthPercent}%;"></div>
          </div>
          <span>HP: ${monster.currentHealth} / ${monster.maxHealth}</span><br>
          <span>Reward: <span style="color:var(--accent)">+${monster.xp}xp</span>, <span style="color:var(--accent)">$${monster.money}</span></span><br>
          <button ${monster.currentHealth<=0?'disabled':''}>Fight</button>
        `;
        const btn = div.querySelector('button');
        btn.onclick = function() {
          // Calculate total hero power (sum of owned heroes' mps)
          let power = 0;
          player.heroesOwned.forEach(id => {
            const hero = heroes.find(h => h.id === id);
            if (!hero) return;
            let classBoost = 1;
            if (hero.class === "Tech") classBoost = player.techBoost || 1;
            if (hero.class === "Magic") classBoost = player.magicBoost || 1;
            if (hero.class === "Strength") classBoost = player.strengthBoost || 1;
            if (hero.class === "Speed") classBoost = player.speedBoost || 1;
            power += hero.mps * classBoost;
          });
          // Add crafting bonuses
          power += (player.craftedItems.sword || 0) * 7;
          power += (player.craftedItems.power || 0) * 15;
          // Simple crit chance bonus for daggers
          let crit = false;
          if ((player.craftedItems.dagger || 0) > 0) {
            for (let i=0;i<player.craftedItems.dagger;i++) {
              if (Math.random() < 0.07) { crit = true; break; }
            }
          }
          if (crit) power = Math.round(power * 1.3);
          // Minimum damage
          let damage = Math.max(1, Math.round(power / 3));
          // Shields: reduce monster counter-damage (not shown visually)
          monster.currentHealth -= damage;
          if (monster.currentHealth <= 0) {
            monster.currentHealth = 0;
            player.xp += monster.xp;
            player.money += monster.money;
            addLog(`You defeated ${monster.name}! +$${monster.money} +${monster.xp}xp`);
            flashMoney();
            checkLevelUp();
            // Reset monster after a short delay
            setTimeout(() => {
              monster.currentHealth = monster.maxHealth;
              updateMonstersUI();
            }, 600);
          } else {
            addLog(`You hit ${monster.name} for ${damage}${crit?' (CRIT!)':''} damage! (${monster.currentHealth} HP left)`);
            updateMonstersUI();
          }
          updatePlayerUI();
        };
        monsterListEl.appendChild(div);
      });
    }

    // --- Misc ---
    function init() {
      updateAll();
      addLog("Game started!");
    }
    init();
    // === NAME, MAX, AUTO-GRIND SYSTEM ===

let playerName = "";
let autoGrindActive = false;
let autoGrindInterval = null;

function setPlayerName() {
  playerName = document.getElementById('playerNameInput').value.trim();
  document.getElementById('currentPlayerName').textContent = playerName || "Anonymous";
  if (playerName.toLowerCase() === "developer") {
    document.getElementById('maxButton').style.display = 'inline-block';
  } else {
    document.getElementById('maxButton').style.display = 'none';
  }
}
document.getElementById('setNameBtn').onclick = setPlayerName;
document.getElementById('playerNameInput').addEventListener('keyup', function(e) {
  if (e.key === 'Enter') setPlayerName();
});

document.getElementById('maxButton').onclick = function() {
  if (confirm("Max out everything? This cannot be undone!")) {
    player.level = 9999;
    player.xp = 9999999999;
    player.money = 1e100;
    player.incomeBoost = 1e9;
    player.missionBoost = 1e9;
    player.techBoost = 100;
    player.magicBoost = 100;
    player.strengthBoost = 100;
    player.speedBoost = 100;
    player.heroesOwned = heroes.map(h => h.id);
    Object.keys(player.resources).forEach(k => player.resources[k] = 9999);
    Object.keys(player.craftedItems).forEach(k => player.craftedItems[k] = 999);
    upgrades.forEach(u => {
      u.purchased = true;
      if (typeof u.apply === "function") u.apply(player);
    });
    player.currentMap = maps[maps.length-1].name;
    player.heroMissions = {};
    player.heroesOwned.forEach(heroId => {
      const bestMission = missions.filter(m => player.level >= m.minLevel).slice(-1)[0];
      player.heroMissions[heroId] = { missionId: bestMission?.id, inProgress: false, timeLeft: 0 };
    });
    monsterStates = getMonsterListForPlayerLevel(player.level).map(m => ({
      ...m,
      currentHealth: 0
    }));
    updateAll();
    addLog("DEVELOPER MODE: Everything maxed out!");
    alert("Everything is maxed out!");
  }
};

document.getElementById('autoGrindButton').onclick = function() {
  autoGrindActive = !autoGrindActive;
  this.textContent = 'Auto-Grind: ' + (autoGrindActive ? 'ON' : 'OFF');
  if (autoGrindActive) startAutoGrind();
  else stopAutoGrind();
};

function startAutoGrind() {
  if (autoGrindInterval) clearInterval(autoGrindInterval);
  autoGrindInterval = setInterval(() => {
    // Auto-complete the best mission for each hero
    player.heroesOwned.forEach(heroId => {
      const hero = heroes.find(h => h.id === heroId);
      if (!hero) return;
      let assign = player.heroMissions[heroId] || {};
      const availableMissions = missions.filter(m => player.level >= m.minLevel);
      if (!availableMissions.length) return;
      const bestMission = availableMissions[availableMissions.length-1];
      if (!assign.inProgress) {
        assign.missionId = bestMission.id;
        assign.inProgress = false;
        assign.timeLeft = 0;
        let missionMoney = bestMission.moneyReward * (player.missionBoost || 1);
        player.money += missionMoney;
        player.xp += bestMission.xpReward;
        addLog(`[Auto-Grind] ${hero.name} auto-completed ${bestMission.name}: +$${missionMoney}, +${bestMission.xpReward}xp`);
        flashMoney();
        checkLevelUp();
        updateAll();
      }
      player.heroMissions[heroId] = assign;
    });
    // Auto-fight best available monster
    const monsters = getMonsterListForPlayerLevel(player.level);
    let bestIdx = monsters.length-1;
    if (monsterStates.length !== monsters.length) {
      monsterStates = monsters.map(m => ({
        ...m,
        currentHealth: m.maxHealth
      }));
    }
    let monster = monsterStates[bestIdx];
    if (monster && monster.currentHealth > 0) {
      let power = 0;
      player.heroesOwned.forEach(id => {
        const hero = heroes.find(h => h.id === id);
        if (!hero) return;
        let classBoost = 1;
        if (hero.class === "Tech") classBoost = player.techBoost || 1;
        if (hero.class === "Magic") classBoost = player.magicBoost || 1;
        if (hero.class === "Strength") classBoost = player.strengthBoost || 1;
        if (hero.class === "Speed") classBoost = player.speedBoost || 1;
        power += hero.mps * classBoost;
      });
      power += (player.craftedItems.sword || 0) * 7;
      power += (player.craftedItems.power || 0) * 15;
      let crit = false;
      if ((player.craftedItems.dagger || 0) > 0) {
        for (let i=0;i<player.craftedItems.dagger;i++) {
          if (Math.random() < 0.07) { crit = true; break; }
        }
      }
      if (crit) power = Math.round(power * 1.3);
      let damage = Math.max(1, Math.round(power / 3));
      monster.currentHealth -= damage;
      if (monster.currentHealth <= 0) {
        monster.currentHealth = 0;
        player.xp += monster.xp;
        player.money += monster.money;
        addLog(`[Auto-Grind] Defeated ${monster.name}: +$${monster.money}, +${monster.xp}xp`);
        flashMoney();
        checkLevelUp();
        setTimeout(() => {
          monster.currentHealth = monster.maxHealth;
          updateMonstersUI();
        }, 300);
      } else {
        addLog(`[Auto-Grind] Hit ${monster.name} for ${damage}${crit?' (CRIT!)':''} (${monster.currentHealth} HP left)`);
        updateMonstersUI();
      }
      updatePlayerUI();
    }
  }, 2000);
}
function stopAutoGrind() {
  if (autoGrindInterval) clearInterval(autoGrindInterval);
  autoGrindInterval = null;
}
  </script>
  <script>
// Crash handler: gracefully logs errors and tries a soft reset (no pop-up shown)
window.onerror = function(message, source, lineno, colno, error) {
    // Optional: Log error details for diagnostics (e.g., to a backend/server)
    // sendErrorToServer({ message, source, lineno, colno, error: error ? error.stack : null });

    // Attempt a soft reset if available
    try {
        if (typeof softGameReset === 'function') {
            softGameReset();
        }
    } catch (e) {
        // Fail silently
    }
    // Prevent default browser error pop-up
    return true;
};

window.addEventListener('unhandledrejection', function(event) {
    // Optional: Log error details for diagnostics
    // sendErrorToServer({ message: event.reason && event.reason.message, stack: event.reason && event.reason.stack });

    // Attempt a soft reset if available
    try {
        if (typeof softGameReset === 'function') {
            softGameReset();
        }
    } catch (e) {
        // Fail silently
    }
    // Prevent default browser error pop-up
    event.preventDefault();
});

// Example softGameReset implementation (customize as needed for your game)
function softGameReset() {
    // Place code here to reset only volatile game state, not player progress
    // For example, reload main UI or reset timers, but don't wipe out saves!
    // Example:
    // if (window.stopAllIntervals) stopAllIntervals();
    // if (window.reloadGameUI) reloadGameUI();
    // Optionally: add a subtle status message if desired (not required)
}

// Optional: Example error logging function (requires server-side support)
// function sendErrorToServer(errorData) {
//     fetch('/log-error', {
//         method: 'POST',
//         body: JSON.stringify(errorData),
//         headers: { 'Content-Type': 'application/json' }
//     }).catch(() => {});
// }
</script>
  <script>
const tips = [
  "Tip: Upgrade your heroes regularly for maximum power!",
  "Tip: Idle income continues even while you're offline.",
  "Tip: Complete achievements for extra rewards.",
  "Tip: Some heroes have special abilitiesâ€”try them all!",
  "Tip: Donâ€™t forget to check daily rewards."
];

let tipIndex = 0;
function cycleTips() {
  document.getElementById('loading-tip').textContent = tips[tipIndex];
  tipIndex = (tipIndex + 1) % tips.length;
}
setInterval(cycleTips, 2200); // Switch tips every 2.2 seconds

// Simulate loading progress
let progress = 0;
function updateLoading() {
  progress += Math.random() * 10 + 5; // random increment
  if (progress > 100) progress = 100;
  document.getElementById('loading-bar').style.width = progress + '%';
  document.getElementById('loading-percent').textContent = Math.floor(progress) + '%';
  if (progress < 100) {
    setTimeout(updateLoading, 250);
  } else {
    setTimeout(() => {
      document.getElementById('loading-screen').style.display = 'none';
    }, 600);
  }
}
window.addEventListener('DOMContentLoaded', updateLoading);
</script>
</body>
</html>
