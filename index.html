<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Idle Superhero Tycoon game. Collect, upgrade, and assign heroes of different classes to missions!" />
  <title>Idle Superhero Tycoon</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --tech-color: #4fc3f7;
      --magic-color: #ba68c8;
      --strength-color: #ff7043;
      --speed-color: #aed581;
      --accent: #ffeb3b;
      --bg-main: #111;
      --bg-section: #1a1a1a;
      --bg-card: #23272f;
      --text-main: #fff;
      --shadow: 0 2px 8px 0 rgba(0,0,0,0.11);
      --monster-color: #ffb74d;
    }
    body {
      background: var(--bg-main);
      color: var(--text-main);
      font-family: 'Montserrat', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    main { max-width: 950px; margin: 0 auto; padding: 15px; }
    header { text-align: center; padding: 22px 0 10px 0; }
    h1,h2 { font-weight: 700; }
    section { background: var(--bg-section); margin: 14px 0; border-radius: 10px; padding: 18px; box-shadow: var(--shadow);}
    button, select {
      font-family: inherit;
      font-size: 1em;
      border-radius: 6px;
      border: none;
      outline: none;
      padding: 10px 22px;
      background: var(--accent);
      color: #111;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 4px 0 rgba(0,0,0,0.08);
    }
    button:hover:not(:disabled) {
      background: #ffd600;
      color: #111;
      box-shadow: 0 4px 12px 0 rgba(0,0,0,0.16);
    }
    .hero, .mission, .shop-item, .gacha-result, .map-button, .upgrade-item, .monster-card {
      background: var(--bg-card);
      padding: 13px 10px;
      border-radius: 12px;
      text-align: center;
      box-shadow: var(--shadow);
      transition: transform 0.15s, box-shadow 0.15s;
      margin-bottom: 8px;
    }
    .monster-card {
      border: 2px solid var(--monster-color);
      margin-bottom: 16px;
    }
    .hero:hover, .mission:hover, .shop-item:hover, .gacha-result:hover, .map-button:hover, .upgrade-item:hover, .monster-card:hover {
      transform: translateY(-3px) scale(1.025);
      box-shadow: 0 4px 16px 0 rgba(0,0,0,0.18);
    }
    .locked { opacity: 0.4; cursor: not-allowed; }
    #log-content {
      max-height: 200px;
      overflow-y: auto;
      background: #181818;
      padding: 10px;
      border-radius: 6px;
      font-size: 0.96em;
      box-shadow: var(--shadow);
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .class { font-weight: bold; display: inline-block; min-width: 65px; }
    .class.tech { color: var(--tech-color); }
    .class.magic { color: var(--magic-color); }
    .class.strength { color: var(--strength-color); }
    .class.speed { color: var(--speed-color); }
    label[for], select, #start-mission, #buy-gacha { margin-top: 10px; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 18px;
    }
    @media (max-width: 600px) {
      main { padding: 5px; }
      section { padding: 10px; }
      .grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
    }
    #toggle-log-btn {
      margin-bottom: 8px;
    }
    #log-section[hidden] { display: none; }
    #start-all-missions-btn {
      margin-bottom: 15px;
      display: block;
    }
    #total-mps {
      font-weight: bold;
      color: var(--accent);
      font-size: 1.2em;
    }
    .shop-item button {
      font-size: 1.1em;
      padding: 10px 22px;
      margin-top: 8px;
    }
    .money-flash {
      animation: flashMoney 0.5s;
    }
    @keyframes flashMoney {
      0% { background: #ffd600; color: #222; }
      100% { background: none; color: inherit; }
    }
    .monster-healthbar-bg {
      background: #333;
      border-radius: 6px;
      height: 16px;
      width: 100%;
      margin: 8px 0;
    }
    .monster-healthbar {
      background: #ffb74d;
      height: 100%;
      border-radius: 6px;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Idle Superhero Tycoon</h1>
    </header>
    <section aria-labelledby="player-stats-title" id="player-stats">
      <h2 id="player-stats-title">Player Stats</h2>
      <p>Level: <span id="level">1</span></p>
      <p>XP: <span id="xp">0</span> / <span id="xpToLevel">100</span></p>
      <p>Money: $<span id="money">100</span></p>
      <p>Current Map: <span id="currentMap">Map 1</span></p>
      <button class="save-load-btn" id="save-btn" aria-label="Save Game">Save Game</button>
      <button class="save-load-btn" id="load-btn" aria-label="Load Game">Load Game</button>
      <button class="save-load-btn" id="reset-btn" aria-label="Reset Game">Reset</button>
    </section>
    <!-- Hideable Log Section -->
    <section id="log-section">
      <button id="toggle-log-btn" aria-expanded="true">Hide Log</button>
      <h2 style="display:inline-block">Game Log</h2>
      <div id="log-content"></div>
    </section>
    <section aria-labelledby="class-legend-title" id="class-legend">
      <h2 id="class-legend-title">Hero Classes</h2>
      <ul style="display:flex; gap:24px; list-style:none; padding:0; margin:0;">
        <li><span class="class tech" title="Technology heroes excel at gadgets and hacking.">Tech</span></li>
        <li><span class="class magic" title="Magic heroes use spells and arcane arts.">Magic</span></li>
        <li><span class="class strength" title="Strength heroes focus on raw power.">Strength</span></li>
        <li><span class="class speed" title="Speed heroes are quick and agile.">Speed</span></li>
      </ul>
    </section>
    <section aria-labelledby="map-switch-title" id="map-switch">
      <h2 id="map-switch-title">Maps <span aria-label="Unlock maps by leveling up heroes">(Unlock every few hero levels)</span></h2>
      <div class="grid" id="map-buttons"></div>
    </section>
    <section aria-labelledby="heroes-title" id="heroes">
      <h2 id="heroes-title">Owned Heroes</h2>
      <div class="grid" id="heroes-list"></div>
      <p style="margin-top:10px">Total Money Per Second: $<span id="total-mps">0</span></p>
    </section>
    <section aria-labelledby="shop-title" id="shop">
      <h2 id="shop-title">Hero Shop</h2>
      <label for="class-filter">Filter by Class:</label>
      <select id="class-filter" aria-label="Filter heroes by class">
        <option value="">All</option>
        <option value="Tech">Tech</option>
        <option value="Magic">Magic</option>
        <option value="Strength">Strength</option>
        <option value="Speed">Speed</option>
      </select>
      <div class="grid" id="shop-heroes"></div>
    </section>
    <!-- Research Lab Section -->
    <section aria-labelledby="lab-title" id="lab">
      <h2 id="lab-title">Research Lab</h2>
      <div class="grid" id="upgrade-list"></div>
    </section>
    <section aria-labelledby="missions-title" id="missions">
      <h2 id="missions-title">Missions</h2>
      <button id="start-all-missions-btn">Start All Missions</button>
      <div class="grid" id="missions-list"></div>
    </section>
    <!-- MONSTER FIGHTING SYSTEM -->
    <section aria-labelledby="monster-title" id="monster-arena">
      <h2 id="monster-title">Monster Arena</h2>
      <div id="monster-list"></div>
    </section>
  </main>
  <script>
    // --- Constants and Data ---
    const MAP_COUNT = 15;
    const HERO_COUNT = 50;
    const LEVELS_PER_MAP = 20;
    const mapNames = [
      "Skyline City","Shadow District","Neon Harbor","Crystal Caverns","Ironworks","Solaris Heights","Quantum Quarter",
      "Twilight Outlands","Meteorite Falls","Circuit Spires","Aetherium Isles","Obsidian Expanse","Celestial Park",
      "Echoing Depths","Titan's Reach"
    ];
    const maps = Array.from({length: MAP_COUNT}, (_,i) => ({
      name: mapNames[i],
      unlockLevel: 1 + i * LEVELS_PER_MAP
    }));

    const heroNames = [
      "Blaze", "Frostbite", "Shockwave", "Inferno", "Glacier", "Sandstorm", "Wildwood", "Tsunami", "Voltar", "Blizzard",
      "Cinder", "Echo", "Ironclad", "Stormbreaker", "Phantom", "Nova", "Titan", "Solarflare", "Quake", "Tempest",
      "Shadowstrike", "Glitch", "Aurora", "Ember", "Fang", "Hydra", "Bolt", "Vortex", "Frostfang", "Dune",
      "Gale", "Nightshade", "Tide", "Pulse", "Flare", "Glint", "Blitz", "Shadow", "Cascade", "Steelclaw",
      "Quasar", "Nebula", "Pyro", "Arctic Fox", "Mirage", "Specter", "Solaris", "Cyclone", "Darkwave", "Luminara"
    ];
    while (heroNames.length < HERO_COUNT) heroNames.push("Hero" + (heroNames.length + 1));

    const heroClasses = ["Tech", "Magic", "Strength", "Speed"];
    const heroes = Array.from({length: HERO_COUNT}, (_,i) => ({
      id: i+1,
      name: heroNames[i],
      mps: 1 + Math.floor(Math.random()*10) + i,
      price: 100 + i*50,
      map: maps[Math.floor(i/(HERO_COUNT/MAP_COUNT))].name,
      unlockLevel: 1 + Math.floor(i/(HERO_COUNT/MAP_COUNT)) * LEVELS_PER_MAP,
      class: heroClasses[i % heroClasses.length]
    }));

    // --- Monster Fighting System ---
    const monsterNames = [
      "Street Goon", "Mega Bot", "Arcane Shade", "Steel Serpent", "Crimson Ogre", "Cyber Wraith",
      "Titan Drone", "Night Howler", "Crystal Hydra", "Lava Fiend", "Quantum Slime", "Spectral Wolf",
      "Obsidian Golem", "Meteor Spider", "Celestial Squid"
    ];
    // Each monster: name, health, xpReward, moneyReward
    function getMonsterListForPlayerLevel(lv) {
      // Unlocks more monsters as you level up
      let unlocked = Math.min(Math.floor(lv / 5) + 1, monsterNames.length);
      let monsters = [];
      for (let i = 0; i < unlocked; ++i) {
        monsters.push({
          id: i+1,
          name: monsterNames[i],
          maxHealth: 20 + i*15 + lv*3,
          xp: 10 + i*5 + lv*2,
          money: 15 + i*8 + lv*3,
          level: i*3 + 1
        });
      }
      return monsters;
    }

    // --- Missions (kept as before) ---
    const missionNamesPerMap = [
      ["Stop the Bank Heist", "Rescue the Mayor", "Defuse the Skyscraper Bomb", "Intercept Midnight Robbery", "Save the Runaway Train", "Save the Cat from a Tree", "Repair the Broken Bridge"],
      ["Infiltrate the Syndicate", "Shadow Alley Chase", "Break the Smuggling Ring", "Decode Secret Messages", "Silent Sabotage"],
      ["Guard the Neon Docks", "Battle the Pirate Crew", "Protect Cargo Ships", "Halt Black Market Deal", "Rescue Hostages at Pier 9"],
      ["Retrieve Crystal Shards", "Defeat the Cave Beast", "Rescue Trapped Miners", "Map the Hidden Passages", "Secure the Cavern Entrance"],
      ["Stop Factory Sabotage", "Rescue Workers", "Shut Down Rogue Machines", "Protect Prototype Tech", "Investigate Explosions"],
      ["Prevent Solar Flare", "Protect the Observatory", "Evacuate Residents", "Apprehend Arsonist", "Restore Power Grid"],
      ["Contain Anomaly", "Rescue Lab Scientists", "Stop Tech Theft", "Seal Quantum Rift", "Hack the Mainframe"],
      ["Patrol the Borderlands", "Rescue Lost Explorers", "Defeat Outland Marauders", "Secure Outpost", "Recover Lost Supplies"],
      ["Investigate Meteor Crash", "Evacuate Impact Zone", "Battle Alien Invaders", "Research Meteor Fragments", "Quarantine Contaminated Area"],
      ["Protect Data Towers", "Chase Cyber Criminals", "Repair Main Circuits", "Install Security Upgrades", "Foil Hacking Attempt"],
      ["Rescue Drifting Ships", "Battle Sky Pirates", "Seal Dimensional Rifts", "Protect Floating Gardens", "Restore Weather Control"],
      ["Track Rogue Mutants", "Secure Resource Convoy", "Defend Outlying Camps", "Investigate Disappearances", "Survey Dangerous Terrain"],
      ["Calm the Rampaging Beast", "Rescue Tourists", "Protect Ancient Relics", "Stop the Park Poachers", "Find Lost Children"],
      ["Explore the Abyss Ruins", "Rescue Divers", "Fight the Abyssal Leviathan", "Secure the Research Sub", "Map the Underwater Tunnels"],
      ["Climb the Titan Spire", "Defeat the Giant Golem", "Rescue the Expedition", "Protect the Mountain Base", "Secure the Ancient Relic"]
    ];
    let missions = [];
    let missionId = 1;
    for (let mapIdx = 0; mapIdx < missionNamesPerMap.length; mapIdx++) {
      for (let i = 0; i < missionNamesPerMap[mapIdx].length; i++) {
        missions.push({
          id: missionId,
          name: missionNamesPerMap[mapIdx][i],
          xpReward: 20 + mapIdx * 5 + i,
          moneyReward: 25 + mapIdx * 10 + i * 3,
          minLevel: 1 + mapIdx * LEVELS_PER_MAP,
          baseDuration: 5 + mapIdx + i
        });
        missionId++;
      }
    }

    // --- Player state ---
    let player = {
      level: 1,
      xp: 0,
      money: 100,
      heroesOwned: [1],
      currentMap: maps[0].name,
      heroMissions: {},
      incomeBoost: 1,
      missionBoost: 1,
      techBoost: 1,
      magicBoost: 1,
      strengthBoost: 1,
      speedBoost: 1
      // upgradesPurchased will be added automatically if present in save
    };

    // FIGHTING MONSTER SYSTEM: track monster states
    let monsterStates = [];

    // --- UI elements ---
    const levelEl = document.getElementById('level');
    const xpEl = document.getElementById('xp');
    const xpToLevelEl = document.getElementById('xpToLevel');
    const moneyEl = document.getElementById('money');
    const currentMapEl = document.getElementById('currentMap');
    const heroesListEl = document.getElementById('heroes-list');
    const shopHeroesEl = document.getElementById('shop-heroes');
    const missionsListEl = document.getElementById('missions-list');
    const mapButtonsEl = document.getElementById('map-buttons');
    const saveBtn = document.getElementById('save-btn');
    const loadBtn = document.getElementById('load-btn');
    const resetBtn = document.getElementById('reset-btn');
    const totalMpsEl = document.getElementById('total-mps');
    const classFilterEl = document.getElementById('class-filter');
    const upgradeListEl = document.getElementById('upgrade-list');
    const logContentEl = document.getElementById('log-content');
    const logSectionEl = document.getElementById('log-section');
    const toggleLogBtn = document.getElementById('toggle-log-btn');
    const startAllMissionsBtn = document.getElementById('start-all-missions-btn');
    const monsterListEl = document.getElementById('monster-list');

    // --- Research Lab Upgrades ---
    const upgrades = [
      {
        id: 1,
        name: "Boost Hero Income +10%",
        desc: "All heroes earn 10% more money.",
        cost: 500,
        purchased: false,
        apply(player) { player.incomeBoost *= 1.10; }
      },
      {
        id: 2,
        name: "Boost Hero Income +25%",
        desc: "All heroes earn 25% more money.",
        cost: 2500,
        purchased: false,
        apply(player) { player.incomeBoost *= 1.25; }
      },
      {
        id: 3,
        name: "Boost Hero Income +50%",
        desc: "All heroes earn 50% more money.",
        cost: 10000,
        purchased: false,
        apply(player) { player.incomeBoost *= 1.50; }
      },
      {
        id: 4,
        name: "Mission Rewards +20%",
        desc: "Earn 20% more money from missions.",
        cost: 20000,
        purchased: false,
        apply(player) { player.missionBoost *= 1.20; }
      },
      {
        id: 5,
        name: "Tech Class Power",
        desc: "Tech class heroes earn double.",
        cost: 25000,
        purchased: false,
        apply(player) { player.techBoost = 2; }
      },
      {
        id: 6,
        name: "Magic Class Power",
        desc: "Magic class heroes earn double.",
        cost: 25000,
        purchased: false,
        apply(player) { player.magicBoost = 2; }
      },
      {
        id: 7,
        name: "Strength Class Power",
        desc: "Strength class heroes earn double.",
        cost: 25000,
        purchased: false,
        apply(player) { player.strengthBoost = 2; }
      },
      {
        id: 8,
        name: "Speed Class Power",
        desc: "Speed class heroes earn double.",
        cost: 25000,
        purchased: false,
        apply(player) { player.speedBoost = 2; }
      }
    ];

    function updatePlayerUI() {
      levelEl.textContent = player.level;
      xpEl.textContent = player.xp;
      xpToLevelEl.textContent = xpToNextLevel(player.level);
      moneyEl.textContent = player.money.toFixed(2);
    }

    function flashMoney() {
      moneyEl.classList.add('money-flash');
      setTimeout(() => moneyEl.classList.remove('money-flash'), 400);
    }

    function updateHeroesUI() {
      heroesListEl.innerHTML = '';
      let totalMps = 0;
      player.heroesOwned.forEach((id) => {
        const hero = heroes.find(h => h.id === id);
        if (!hero) return;
        // Apply per-class boosts:
        let classBoost = 1;
        if (hero.class === "Tech") classBoost = player.techBoost || 1;
        if (hero.class === "Magic") classBoost = player.magicBoost || 1;
        if (hero.class === "Strength") classBoost = player.strengthBoost || 1;
        if (hero.class === "Speed") classBoost = player.speedBoost || 1;
        totalMps += hero.mps * classBoost;
        const div = document.createElement('div');
        div.className = 'hero';
        div.innerHTML = `<strong>${hero.name}</strong><br>
          <span class="class ${hero.class.toLowerCase()}">${hero.class}</span><br>
          Map: ${hero.map}<br>
          MPS: $${(hero.mps * classBoost).toFixed(2)}`;
        heroesListEl.appendChild(div);
      });
      // Apply upgrade boost
      const boost = player.incomeBoost || 1;
      totalMpsEl.textContent = (totalMps * boost).toFixed(2);
    }

    classFilterEl.onchange = updateShopUI;
    function updateShopUI() {
      shopHeroesEl.innerHTML = '';
      const filter = classFilterEl.value;
      const available = heroes.filter(h =>
        h.map === player.currentMap &&
        !player.heroesOwned.includes(h.id) &&
        player.level >= h.unlockLevel &&
        (filter === "" || h.class === filter)
      );
      if (!available.length) {
        shopHeroesEl.textContent = 'No heroes available to buy here.';
        return;
      }
      available.forEach(hero => {
        const div = document.createElement('div');
        div.className = 'shop-item';
        div.innerHTML = `<strong>${hero.name}</strong><br>
          <span class="class ${hero.class.toLowerCase()}">${hero.class}</span><br>
          Price: $${hero.price}<br>
          MPS: $${hero.mps}<br>
          <button ${player.money < hero.price ? 'disabled' : ''}>Buy</button>`;
        div.querySelector('button').onclick = function() {
          if (player.money >= hero.price) {
            player.money -= hero.price;
            player.heroesOwned.push(hero.id);
            addLog(`You bought ${hero.name} for $${hero.price}!`);
            flashMoney();
            updateAll();
          } else {
            addLog("Not enough money to buy this hero.");
          }
        };
        shopHeroesEl.appendChild(div);
      });
    }

    function updateMapButtonsUI() {
      mapButtonsEl.innerHTML = '';
      maps.forEach(map => {
        const unlocked = player.level >= map.unlockLevel;
        const btn = document.createElement('button');
        btn.textContent = map.name + (unlocked ? '' : ' (Locked)');
        btn.className = 'map-button' + (unlocked ? '' : ' locked');
        btn.disabled = !unlocked;
        btn.onclick = () => {
          if (player.currentMap === map.name) return;
          player.currentMap = map.name
          updatePlayerUI();
          updateShopUI();
        };
        mapButtonsEl.appendChild(btn);
      });
    }

    // --- MISSIONS UI ---
    function updateMissionsUI() {
      missionsListEl.innerHTML = '';
      player.heroesOwned.forEach(heroId => {
        const hero = heroes.find(h => h.id === heroId);
        const assign = player.heroMissions[heroId] || {};
        const div = document.createElement('div');
        div.className = 'mission';
        // Mission assignment dropdown
        let missionOptions = `<option value="">Assign Mission</option>`;
        missions.forEach(miss => {
          if (player.level >= miss.minLevel) {
            missionOptions += `<option value="${miss.id}" ${assign.missionId==miss.id?'selected':''}>${miss.name}</option>`;
          }
        });
        if (assign.inProgress) {
          div.innerHTML = `<strong>${hero.name}</strong><br>
            <span class="class ${hero.class.toLowerCase()}">${hero.class}</span><br>
            On: ${missions.find(m=>m.id===assign.missionId)?.name || 'Unknown'}<br>
            Time left: <span id="hero-mission-timer-${heroId}">${assign.timeLeft}</span>s<br>
            <button disabled>In Progress</button>`;
        } else {
          div.innerHTML = `<strong>${hero.name}</strong><br>
            <span class="class ${hero.class.toLowerCase()}">${hero.class}</span><br>
            <select class="hero-mission-select" aria-label="Assign mission to ${hero.name}">${missionOptions}</select>
            <button>Start Mission</button>`;
          const select = div.querySelector('.hero-mission-select');
          select.onchange = (e) => {
            assign.missionId = parseInt(e.target.value)||null;
            player.heroMissions[heroId] = assign;
          };
          div.querySelector('button').onclick = () => {
            if (!assign.missionId) {
              alert('Assign a mission first!');
              return;
            }
            assign.inProgress = true;
            const base = missions.find(m=>m.id===assign.missionId);
            assign.timeLeft = base.baseDuration;
            player.heroMissions[heroId] = assign;
            addLog(`${hero.name} started ${base.name}.`);
            updateMissionsUI();
            startHeroMissionTimer(heroId);
          };
        }
        missionsListEl.appendChild(div);
      });
    }

    // --- "Start All Missions" with auto-assign logic ---
    startAllMissionsBtn.onclick = function() {
      player.heroesOwned.forEach(heroId => {
        let assign = player.heroMissions[heroId] || {};
        if (!assign.inProgress) {
          if (!assign.missionId) {
            // Auto-assign the first available mission for this hero
            const available = missions.filter(miss => player.level >= miss.minLevel);
            if (available.length) {
              assign.missionId = available[0].id;
            }
          }
          if (assign.missionId) {
            assign.inProgress = true;
            const base = missions.find(m => m.id === assign.missionId);
            assign.timeLeft = base.baseDuration;
            player.heroMissions[heroId] = assign;
            addLog(`${heroes.find(h => h.id === heroId).name} started ${base.name}.`);
            startHeroMissionTimer(heroId);
          }
        }
      });
      updateMissionsUI();
    };

    function updateLabUI() {
      upgradeListEl.innerHTML = '';
      upgrades.forEach((upg, idx) => {
        const div = document.createElement('div');
        div.className = 'upgrade-item';
        div.innerHTML = `<strong>${upg.name}</strong><br>
          <span style="font-size:0.95em">${upg.desc}</span><br>
          Cost: $${upg.cost}<br>
          <button ${upg.purchased || player.money < upg.cost ? 'disabled' : ''}>
            ${upg.purchased ? 'Purchased' : 'Buy'}
          </button>`;
        div.querySelector('button').onclick = function() {
          if (player.money >= upg.cost && !upg.purchased) {
            player.money -= upg.cost;
            upg.purchased = true;
            upg.apply(player);
            addLog(`You bought upgrade: ${upg.name}`);
            flashMoney();
            updateAll();
          }
        };
        upgradeListEl.appendChild(div);
      });
    }

    function xpToNextLevel(level) {
      return 100 + (level - 1) * 50;
    }

    function updateAll() {
      updatePlayerUI();
      updateHeroesUI();
      updateShopUI();
      updateMapButtonsUI();
      updateMissionsUI();
      updateLabUI();
      updateMonstersUI();
    }

    // Hero income (idle)
    setInterval(() => {
      let totalMps = 0;
      player.heroesOwned.forEach(id => {
        const hero = heroes.find(h => h.id === id);
        if (!hero) return;
        let classBoost = 1;
        if (hero.class === "Tech") classBoost = player.techBoost || 1;
        if (hero.class === "Magic") classBoost = player.magicBoost || 1;
        if (hero.class === "Strength") classBoost = player.strengthBoost || 1;
        if (hero.class === "Speed") classBoost = player.speedBoost || 1;
        totalMps += hero.mps * classBoost;
      });
      // Apply upgrade boost
      const boost = player.incomeBoost || 1;
      player.money += totalMps * boost / 2;
      moneyEl.textContent = player.money.toFixed(2);
      totalMpsEl.textContent = (totalMps * boost).toFixed(2);
    }, 500);

    function startHeroMissionTimer(heroId) {
      const assign = player.heroMissions[heroId];
      if (!assign || !assign.inProgress) return;
      function tick() {
        if (!assign.inProgress) return;
        assign.timeLeft -= 1;
        const timerSpan = document.getElementById(`hero-mission-timer-${heroId}`);
        if (timerSpan) timerSpan.textContent = assign.timeLeft;
        if (assign.timeLeft <= 0) {
          assign.inProgress = false;
          const base = missions.find(m=>m.id===assign.missionId);
          let missionMoney = base.moneyReward * (player.missionBoost || 1);
          player.money += missionMoney;
          player.xp += base.xpReward;
          addLog(`${heroes.find(h=>h.id===heroId).name} completed ${base.name}! +$${missionMoney}, +${base.xpReward}xp`);
          flashMoney();
          checkLevelUp();
          updateAll();
        } else {
          setTimeout(tick, 1000);
        }
      }
      tick();
    }

    function checkLevelUp() {
      let nextLevelXp = xpToNextLevel(player.level);
      while (player.xp >= nextLevelXp) {
        player.xp -= nextLevelXp;
        player.level++;
        addLog(`Level Up! Now level ${player.level}.`);
        updateMapButtonsUI();
        updateShopUI();
        updateMissionsUI();
        updateMonstersUI();
        nextLevelXp = xpToNextLevel(player.level);
      }
      updatePlayerUI();
    }

    // --- Game Log Feature ---
    function addLog(msg) {
      if (!logContentEl) return;
      const p = document.createElement('div');
      p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logContentEl.appendChild(p);
      logContentEl.scrollTop = logContentEl.scrollHeight;
    }

    // === UPDATED: Save/load/reset to include upgrades state!
    saveBtn.onclick = function() {
      player.upgradesPurchased = upgrades.map(u => u.purchased);
      player.monsterStates = monsterStates; // Save monster healths
      localStorage.setItem('idle-superhero-save', JSON.stringify(player));
      addLog('Game saved!');
    };
    loadBtn.onclick = function() {
      const data = localStorage.getItem('idle-superhero-save');
      if (data) {
        Object.assign(player, JSON.parse(data));
        // Restore upgrades
        if (player.upgradesPurchased) {
          player.upgradesPurchased.forEach((p, i) => {
            upgrades[i].purchased = p;
            if (p) upgrades[i].apply(player);
          });
        }
        // Restore monster states
        monsterStates = player.monsterStates || [];
        addLog('Game loaded!');
        updateAll();
      }
    };
    resetBtn.onclick = function() {
      if (confirm('Reset your progress?')) {
        localStorage.removeItem('idle-superhero-save');
        addLog('Game reset!');
        location.reload();
      }
    };

    // Hideable log functionality
    toggleLogBtn.onclick = function() {
      if (logContentEl.style.display !== "none") {
        logContentEl.style.display = "none";
        toggleLogBtn.textContent = "Show Log";
        toggleLogBtn.setAttribute('aria-expanded', 'false');
      } else {
        logContentEl.style.display = "";
        toggleLogBtn.textContent = "Hide Log";
        toggleLogBtn.setAttribute('aria-expanded', 'true');
      }
    };

    // --- MONSTER FIGHTING SYSTEM ---
    function updateMonstersUI() {
      // Monsters scale with player level, get list
      const monsters = getMonsterListForPlayerLevel(player.level);
      // If monsterStates array is empty or doesn't match, reset
      if (monsterStates.length !== monsters.length) {
        monsterStates = monsters.map(m => ({
          ...m,
          currentHealth: m.maxHealth
        }));
      }
      monsterListEl.innerHTML = '';
      monsterStates.forEach((monster, idx) => {
        // Card
        const div = document.createElement('div');
        div.className = 'monster-card';
        const healthPercent = Math.max(0, monster.currentHealth/monster.maxHealth*100);
        div.innerHTML = `
          <strong>${monster.name}</strong> (Lv.${monster.level})<br>
          <div class="monster-healthbar-bg">
            <div class="monster-healthbar" style="width:${healthPercent}%;"></div>
          </div>
          <span>HP: ${monster.currentHealth} / ${monster.maxHealth}</span><br>
          <span>Reward: <span style="color:var(--accent)">+${monster.xp}xp</span>, <span style="color:var(--accent)">$${monster.money}</span></span><br>
          <button ${monster.currentHealth<=0?'disabled':''}>Fight</button>
        `;
        const btn = div.querySelector('button');
        btn.onclick = function() {
          // Calculate total hero power (sum of owned heroes' mps)
          let power = 0;
          player.heroesOwned.forEach(id => {
            const hero = heroes.find(h => h.id === id);
            if (!hero) return;
            let classBoost = 1;
            if (hero.class === "Tech") classBoost = player.techBoost || 1;
            if (hero.class === "Magic") classBoost = player.magicBoost || 1;
            if (hero.class === "Strength") classBoost = player.strengthBoost || 1;
            if (hero.class === "Speed") classBoost = player.speedBoost || 1;
            power += hero.mps * classBoost;
          });
          // Player always does at least 1 damage
          let damage = Math.max(1, Math.round(power / 3));
          monster.currentHealth -= damage;
          if (monster.currentHealth <= 0) {
            monster.currentHealth = 0;
            player.xp += monster.xp;
            player.money += monster.money;
            addLog(`You defeated ${monster.name}! +$${monster.money} +${monster.xp}xp`);
            flashMoney();
            checkLevelUp();
          } else {
            addLog(`You hit ${monster.name} for ${damage} damage! (${monster.currentHealth} HP left)`);
          }
          updateMonstersUI();
          updatePlayerUI();
        };
        monsterListEl.appendChild(div);
      });
    }

    function init() {
      updateAll();
      addLog("Game started!");
    }
    init();
  </script>
</body>
</html>
